<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overture Maps Anomaly Analysis Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .gradient-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <div class="gradient-header text-white py-8 px-4 mb-8">
        <div class="container mx-auto">
            <h1 class="text-4xl font-bold mb-2">Overture Maps Anomaly Analysis</h1>
            <p class="text-xl opacity-90">Rule-Based Detection + AI Agent Synthesis</p>
            <p class="text-sm opacity-75 mt-2">
                Releases: <span class="font-mono bg-white/20 px-2 py-1 rounded">2025-08-20.1 -> 2025-09-24.0</span>
                | Generated: 2025-12-03
            </p>
        </div>
    </div>
    
    <div class="container mx-auto px-4 pb-12">
        
        <!-- Executive Summary -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Executive Summary</h2>
            <p class="text-lg text-gray-700 mb-6">Release 2025-09-24.0 shows severe data quality issues with 1004 anomalies (989 critical), dominated by systematic feature count spikes in divisions data affecting 192 countries. The divisions theme accounts for 96% of critical anomalies, with widespread ~100% increases in city counts globally, indicating a likely data processing error or source change.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div class="text-center p-4 bg-blue-50 rounded-lg">
                    <div class="text-4xl font-bold text-blue-600">1004</div>
                    <div class="text-gray-600 text-sm">Rule-Based Alerts</div>
                </div>
                <div class="text-center p-4 bg-green-50 rounded-lg">
                    <div class="text-4xl font-bold text-green-600">5</div>
                    <div class="text-gray-600 text-sm">AI Patterns</div>
                </div>
                <div class="text-center p-4 bg-purple-50 rounded-lg">
                    <div class="text-4xl font-bold text-purple-600">99.5%</div>
                    <div class="text-gray-600 text-sm">Noise Reduction</div>
                </div>
                <div class="text-center p-4 bg-red-50 rounded-lg">
                    <div class="text-4xl font-bold text-red-600">989</div>
                    <div class="text-gray-600 text-sm">Critical Issues</div>
                </div>
                <div class="text-center p-4 bg-orange-50 rounded-lg">
                    <div class="text-4xl font-bold text-orange-600">192</div>
                    <div class="text-gray-600 text-sm">Countries Affected</div>
                </div>
            </div>
        </div>
        
        <!-- Risk Assessment Banner -->
        <div class="bg-red-100 border border-red-300 rounded-xl p-6 mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-xl font-bold text-red-800">Risk Assessment: CRITICAL</h3>
                    <p class="text-red-700">Applications relying on city boundaries, building counts, or administrative divisions will experience significant data inconsistencies and potential service disruptions</p>
                </div>
                <div class="text-right">
                    <div class="text-3xl font-bold text-red-600">92%</div>
                    <div class="text-sm text-red-600">Confidence</div>
                </div>
            </div>
        </div>
        
        <!-- AI Patterns -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">AI-Identified Patterns</h2>
            <p class="text-gray-600 mb-4">The AI agent synthesized 1004 rule-based alerts into 5 actionable patterns:</p>
            
        <div class="bg-white border-l-4 border-red-500 p-4 mb-4 rounded-r-lg shadow">
            <div class="flex justify-between items-start">
                <h4 class="font-semibold text-lg">Global City Count Doubling</h4>
                <span class="px-2 py-1 bg-red-100 text-red-800 rounded text-sm">CRITICAL</span>
            </div>
            <p class="text-gray-600 mt-2">Systematic doubling of city features across all major countries with ~100% increases</p>
            <div class="mt-2 flex gap-4 text-sm text-gray-500">
                <span>Confidence: 95%</span>
                <span>Anomalies: 974</span>
            </div>
            <p class="text-sm text-gray-500 mt-1">Evidence: 974 feature_count_spike anomalies in divisions theme, with consistent ~100% increases: CN (99.94%), CA (98.91%), BR (100.56%), IN (102.32%), JP (100.0%)</p>
            <button onclick="toggleDetails('details_global_city_count_doubling')" class="mt-2 text-sm text-blue-600 hover:text-blue-800">
                ▶ Show underlying anomalies
            </button>
            
            <div id="details_global_city_count_doubling" class="hidden mt-4 border-t pt-4">
                <h5 class="font-semibold text-sm mb-2">Sample Anomalies (10 total):</h5>
                <div class="max-h-64 overflow-y-auto">
                    <table class="w-full text-xs">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-2 py-1 text-left">Theme/Type</th>
                                <th class="px-2 py-1 text-left">Country</th>
                                <th class="px-2 py-1 text-left">Column</th>
                                <th class="px-2 py-1 text-left">Description</th>
                                <th class="px-2 py-1 text-right">Change</th>
                            </tr>
                        </thead>
                        <tbody>
            
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">base/infrastructure</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Net gain of 1,367,815 features (1,501,897 added, 134,082 removed)">Net gain of 1,367,815 features (1,501,897 added, 1...</td>
                                <td class="px-2 py-1 text-right">1.0%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">base/land</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1">names</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="97.7% of lands missing 'names' (2.3% coverage)">97.7% of lands missing 'names' (2.3% coverage)...</td>
                                <td class="px-2 py-1 text-right">0.0%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">base/water</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Total geometry length changed significantly">Total geometry length changed significantly...</td>
                                <td class="px-2 py-1 text-right">-21.9%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">buildings/building</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1">names</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="99.7% of buildings missing 'names' (0.3% coverage)">99.7% of buildings missing 'names' (0.3% coverage)...</td>
                                <td class="px-2 py-1 text-right">0.0%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">buildings/building</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1">num_floors</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="98.2% of buildings missing 'num_floors' (1.8% coverage)">98.2% of buildings missing 'num_floors' (1.8% cove...</td>
                                <td class="px-2 py-1 text-right">0.0%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">buildings/building</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Net loss of 4,318,594 features (4,479,724 added, 8,798,318 removed)">Net loss of 4,318,594 features (4,479,724 added, 8...</td>
                                <td class="px-2 py-1 text-right">-0.2%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">divisions/division</td>
                                <td class="px-2 py-1">BR</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Feature count spiked unexpectedly">Feature count spiked unexpectedly...</td>
                                <td class="px-2 py-1 text-right">100.6%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">divisions/division</td>
                                <td class="px-2 py-1">CA</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Feature count spiked unexpectedly">Feature count spiked unexpectedly...</td>
                                <td class="px-2 py-1 text-right">98.9%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">divisions/division</td>
                                <td class="px-2 py-1">CN</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Feature count spiked unexpectedly">Feature count spiked unexpectedly...</td>
                                <td class="px-2 py-1 text-right">99.9%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">divisions/division</td>
                                <td class="px-2 py-1">EG</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Feature count spiked unexpectedly">Feature count spiked unexpectedly...</td>
                                <td class="px-2 py-1 text-right">102.0%</td>
                            </tr>
                
                        </tbody>
                    </table>
                </div>
                <p class="text-xs text-gray-400 mt-2">Use anomaly_explorer.py to see all anomalies and source files</p>
            </div>
            
        </div>
        
        <div class="bg-white border-l-4 border-red-500 p-4 mb-4 rounded-r-lg shadow">
            <div class="flex justify-between items-start">
                <h4 class="font-semibold text-lg">Infrastructure Data Surge</h4>
                <span class="px-2 py-1 bg-red-100 text-red-800 rounded text-sm">CRITICAL</span>
            </div>
            <p class="text-gray-600 mt-2">Massive net gain of infrastructure features with high addition-to-removal ratio</p>
            <div class="mt-2 flex gap-4 text-sm text-gray-500">
                <span>Confidence: 90%</span>
                <span>Anomalies: 1</span>
            </div>
            <p class="text-sm text-gray-500 mt-1">Evidence: Net gain of 1,367,815 infrastructure features (1,501,897 added vs 134,082 removed), representing 11:1 addition ratio</p>
            <button onclick="toggleDetails('details_infrastructure_data_surge')" class="mt-2 text-sm text-blue-600 hover:text-blue-800">
                ▶ Show underlying anomalies
            </button>
            
            <div id="details_infrastructure_data_surge" class="hidden mt-4 border-t pt-4">
                <h5 class="font-semibold text-sm mb-2">Sample Anomalies (983 total):</h5>
                <div class="max-h-64 overflow-y-auto">
                    <table class="w-full text-xs">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-2 py-1 text-left">Theme/Type</th>
                                <th class="px-2 py-1 text-left">Country</th>
                                <th class="px-2 py-1 text-left">Column</th>
                                <th class="px-2 py-1 text-left">Description</th>
                                <th class="px-2 py-1 text-right">Change</th>
                            </tr>
                        </thead>
                        <tbody>
            
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">base/infrastructure</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Net gain of 1,367,815 features (1,501,897 added, 134,082 removed)">Net gain of 1,367,815 features (1,501,897 added, 1...</td>
                                <td class="px-2 py-1 text-right">1.0%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">divisions/division</td>
                                <td class="px-2 py-1">BR</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Feature count spiked unexpectedly">Feature count spiked unexpectedly...</td>
                                <td class="px-2 py-1 text-right">100.6%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">divisions/division</td>
                                <td class="px-2 py-1">CA</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Feature count spiked unexpectedly">Feature count spiked unexpectedly...</td>
                                <td class="px-2 py-1 text-right">98.9%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">divisions/division</td>
                                <td class="px-2 py-1">CN</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Feature count spiked unexpectedly">Feature count spiked unexpectedly...</td>
                                <td class="px-2 py-1 text-right">99.9%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">divisions/division</td>
                                <td class="px-2 py-1">EG</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Feature count spiked unexpectedly">Feature count spiked unexpectedly...</td>
                                <td class="px-2 py-1 text-right">102.0%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">divisions/division</td>
                                <td class="px-2 py-1">IN</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Feature count spiked unexpectedly">Feature count spiked unexpectedly...</td>
                                <td class="px-2 py-1 text-right">102.3%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">divisions/division</td>
                                <td class="px-2 py-1">IR</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Feature count spiked unexpectedly">Feature count spiked unexpectedly...</td>
                                <td class="px-2 py-1 text-right">98.5%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">divisions/division</td>
                                <td class="px-2 py-1">JP</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Feature count spiked unexpectedly">Feature count spiked unexpectedly...</td>
                                <td class="px-2 py-1 text-right">100.0%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">divisions/division</td>
                                <td class="px-2 py-1">MX</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Feature count spiked unexpectedly">Feature count spiked unexpectedly...</td>
                                <td class="px-2 py-1 text-right">98.7%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">divisions/division</td>
                                <td class="px-2 py-1">PH</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Feature count spiked unexpectedly">Feature count spiked unexpectedly...</td>
                                <td class="px-2 py-1 text-right">101.3%</td>
                            </tr>
                
                        </tbody>
                    </table>
                </div>
                <p class="text-xs text-gray-400 mt-2">Use anomaly_explorer.py to see all anomalies and source files</p>
            </div>
            
        </div>
        
        <div class="bg-white border-l-4 border-red-500 p-4 mb-4 rounded-r-lg shadow">
            <div class="flex justify-between items-start">
                <h4 class="font-semibold text-lg">Building Data Degradation</h4>
                <span class="px-2 py-1 bg-red-100 text-red-800 rounded text-sm">CRITICAL</span>
            </div>
            <p class="text-gray-600 mt-2">Net loss of buildings combined with poor attribute coverage for required fields</p>
            <div class="mt-2 flex gap-4 text-sm text-gray-500">
                <span>Confidence: 85%</span>
                <span>Anomalies: 6</span>
            </div>
            <p class="text-sm text-gray-500 mt-1">Evidence: Net loss of 4,318,594 buildings, 99.7% missing names, 98.2% missing num_floors despite being required fields</p>
            <button onclick="toggleDetails('details_building_data_degradation')" class="mt-2 text-sm text-blue-600 hover:text-blue-800">
                ▶ Show underlying anomalies
            </button>
            
            <div id="details_building_data_degradation" class="hidden mt-4 border-t pt-4">
                <h5 class="font-semibold text-sm mb-2">Sample Anomalies (6 total):</h5>
                <div class="max-h-64 overflow-y-auto">
                    <table class="w-full text-xs">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-2 py-1 text-left">Theme/Type</th>
                                <th class="px-2 py-1 text-left">Country</th>
                                <th class="px-2 py-1 text-left">Column</th>
                                <th class="px-2 py-1 text-left">Description</th>
                                <th class="px-2 py-1 text-right">Change</th>
                            </tr>
                        </thead>
                        <tbody>
            
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">buildings/building</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1">names</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="99.7% of buildings missing 'names' (0.3% coverage)">99.7% of buildings missing 'names' (0.3% coverage)...</td>
                                <td class="px-2 py-1 text-right">0.0%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">buildings/building</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1">num_floors</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="98.2% of buildings missing 'num_floors' (1.8% coverage)">98.2% of buildings missing 'num_floors' (1.8% cove...</td>
                                <td class="px-2 py-1 text-right">0.0%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">buildings/building</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Net loss of 4,318,594 features (4,479,724 added, 8,798,318 removed)">Net loss of 4,318,594 features (4,479,724 added, 8...</td>
                                <td class="px-2 py-1 text-right">-0.2%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">buildings/building</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1">class</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="94.7% of buildings missing 'class' (5.3% coverage)">94.7% of buildings missing 'class' (5.3% coverage)...</td>
                                <td class="px-2 py-1 text-right">0.0%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">buildings/building</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1">height</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="92.1% of buildings missing 'height' (7.9% coverage)">92.1% of buildings missing 'height' (7.9% coverage...</td>
                                <td class="px-2 py-1 text-right">0.0%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">buildings/building</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1">subtype</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="94.6% of buildings missing 'subtype' (5.4% coverage)">94.6% of buildings missing 'subtype' (5.4% coverag...</td>
                                <td class="px-2 py-1 text-right">0.0%</td>
                            </tr>
                
                        </tbody>
                    </table>
                </div>
                <p class="text-xs text-gray-400 mt-2">Use anomaly_explorer.py to see all anomalies and source files</p>
            </div>
            
        </div>
        
        <div class="bg-white border-l-4 border-red-500 p-4 mb-4 rounded-r-lg shadow">
            <div class="flex justify-between items-start">
                <h4 class="font-semibold text-lg">Transportation Network Changes</h4>
                <span class="px-2 py-1 bg-red-100 text-red-800 rounded text-sm">CRITICAL</span>
            </div>
            <p class="text-gray-600 mt-2">Significant modifications to transportation infrastructure across multiple countries</p>
            <div class="mt-2 flex gap-4 text-sm text-gray-500">
                <span>Confidence: 75%</span>
                <span>Anomalies: 27</span>
            </div>
            <p class="text-sm text-gray-500 mt-1">Evidence: 27 critical transportation anomalies with no warnings, suggesting systematic changes rather than gradual updates</p>
            <button onclick="toggleDetails('details_transportation_network_changes')" class="mt-2 text-sm text-blue-600 hover:text-blue-800">
                ▶ Show underlying anomalies
            </button>
            
            <div id="details_transportation_network_changes" class="hidden mt-4 border-t pt-4">
                <h5 class="font-semibold text-sm mb-2">Sample Anomalies (27 total):</h5>
                <div class="max-h-64 overflow-y-auto">
                    <table class="w-full text-xs">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-2 py-1 text-left">Theme/Type</th>
                                <th class="px-2 py-1 text-left">Country</th>
                                <th class="px-2 py-1 text-left">Column</th>
                                <th class="px-2 py-1 text-left">Description</th>
                                <th class="px-2 py-1 text-right">Change</th>
                            </tr>
                        </thead>
                        <tbody>
            
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">transportation/connector</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Net gain of 2,412,319 features (2,797,905 added, 385,586 removed)">Net gain of 2,412,319 features (2,797,905 added, 3...</td>
                                <td class="px-2 py-1 text-right">0.6%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">transportation/segment</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Feature count spiked unexpectedly">Feature count spiked unexpectedly...</td>
                                <td class="px-2 py-1 text-right">100.0%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">transportation/segment</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Feature count spiked unexpectedly">Feature count spiked unexpectedly...</td>
                                <td class="px-2 py-1 text-right">101.0%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">transportation/segment</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Feature count spiked unexpectedly">Feature count spiked unexpectedly...</td>
                                <td class="px-2 py-1 text-right">100.9%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">transportation/segment</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Feature count spiked unexpectedly">Feature count spiked unexpectedly...</td>
                                <td class="px-2 py-1 text-right">100.4%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">transportation/segment</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Feature count spiked unexpectedly">Feature count spiked unexpectedly...</td>
                                <td class="px-2 py-1 text-right">100.4%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">transportation/segment</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Feature count spiked unexpectedly">Feature count spiked unexpectedly...</td>
                                <td class="px-2 py-1 text-right">101.6%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">transportation/segment</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Feature count spiked unexpectedly">Feature count spiked unexpectedly...</td>
                                <td class="px-2 py-1 text-right">100.3%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">transportation/segment</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Feature count spiked unexpectedly">Feature count spiked unexpectedly...</td>
                                <td class="px-2 py-1 text-right">101.2%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">transportation/segment</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Feature count spiked unexpectedly">Feature count spiked unexpectedly...</td>
                                <td class="px-2 py-1 text-right">101.6%</td>
                            </tr>
                
                        </tbody>
                    </table>
                </div>
                <p class="text-xs text-gray-400 mt-2">Use anomaly_explorer.py to see all anomalies and source files</p>
            </div>
            
        </div>
        
        <div class="bg-white border-l-4 border-blue-500 p-4 mb-4 rounded-r-lg shadow">
            <div class="flex justify-between items-start">
                <h4 class="font-semibold text-lg">Geographic Data Expansion</h4>
                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm">INFO</span>
            </div>
            <p class="text-gray-600 mt-2">Major additions of division features concentrated in Asia-Pacific and Latin America</p>
            <div class="mt-2 flex gap-4 text-sm text-gray-500">
                <span>Confidence: 80%</span>
                <span>Anomalies: 2</span>
            </div>
            <p class="text-sm text-gray-500 mt-1">Evidence: Top additions: CN (7,188 divisions), BR (3,530), AR (2,871), VN (2,534), NZ (3,179 division_areas)</p>
            <button onclick="toggleDetails('details_geographic_data_expansion')" class="mt-2 text-sm text-blue-600 hover:text-blue-800">
                ▶ Show underlying anomalies
            </button>
            
            <div id="details_geographic_data_expansion" class="hidden mt-4 border-t pt-4">
                <h5 class="font-semibold text-sm mb-2">Sample Anomalies (10 total):</h5>
                <div class="max-h-64 overflow-y-auto">
                    <table class="w-full text-xs">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-2 py-1 text-left">Theme/Type</th>
                                <th class="px-2 py-1 text-left">Country</th>
                                <th class="px-2 py-1 text-left">Column</th>
                                <th class="px-2 py-1 text-left">Description</th>
                                <th class="px-2 py-1 text-right">Change</th>
                            </tr>
                        </thead>
                        <tbody>
            
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">base/infrastructure</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Net gain of 1,367,815 features (1,501,897 added, 134,082 removed)">Net gain of 1,367,815 features (1,501,897 added, 1...</td>
                                <td class="px-2 py-1 text-right">1.0%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">base/land</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1">names</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="97.7% of lands missing 'names' (2.3% coverage)">97.7% of lands missing 'names' (2.3% coverage)...</td>
                                <td class="px-2 py-1 text-right">0.0%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">base/water</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Total geometry length changed significantly">Total geometry length changed significantly...</td>
                                <td class="px-2 py-1 text-right">-21.9%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">buildings/building</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1">names</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="99.7% of buildings missing 'names' (0.3% coverage)">99.7% of buildings missing 'names' (0.3% coverage)...</td>
                                <td class="px-2 py-1 text-right">0.0%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">buildings/building</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1">num_floors</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="98.2% of buildings missing 'num_floors' (1.8% coverage)">98.2% of buildings missing 'num_floors' (1.8% cove...</td>
                                <td class="px-2 py-1 text-right">0.0%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">buildings/building</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Net loss of 4,318,594 features (4,479,724 added, 8,798,318 removed)">Net loss of 4,318,594 features (4,479,724 added, 8...</td>
                                <td class="px-2 py-1 text-right">-0.2%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">divisions/division</td>
                                <td class="px-2 py-1">BR</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Feature count spiked unexpectedly">Feature count spiked unexpectedly...</td>
                                <td class="px-2 py-1 text-right">100.6%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">divisions/division</td>
                                <td class="px-2 py-1">CA</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Feature count spiked unexpectedly">Feature count spiked unexpectedly...</td>
                                <td class="px-2 py-1 text-right">98.9%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">divisions/division</td>
                                <td class="px-2 py-1">CN</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Feature count spiked unexpectedly">Feature count spiked unexpectedly...</td>
                                <td class="px-2 py-1 text-right">99.9%</td>
                            </tr>
                
                            <tr class="border-b border-gray-100">
                                <td class="px-2 py-1">divisions/division</td>
                                <td class="px-2 py-1">EG</td>
                                <td class="px-2 py-1">None</td>
                                <td class="px-2 py-1 max-w-xs truncate" title="Feature count spiked unexpectedly">Feature count spiked unexpectedly...</td>
                                <td class="px-2 py-1 text-right">102.0%</td>
                            </tr>
                
                        </tbody>
                    </table>
                </div>
                <p class="text-xs text-gray-400 mt-2">Use anomaly_explorer.py to see all anomalies and source files</p>
            </div>
            
        </div>
        
        </div>
        
        <!-- Two Column: Root Causes + Actions -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Root Causes -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Root Cause Hypotheses</h3>
                
        <div class="mb-4 p-3 bg-gray-50 rounded-lg">
            <div class="flex justify-between">
                <span class="font-medium">Data source migration or processing pipeline change for divisions</span>
                <span class="text-sm px-2 py-1 bg-red-100 rounded">HIGH</span>
            </div>
            <p class="text-sm text-gray-500 mt-1">Systematic ~100% increases across all countries in city counts suggests duplicate processing or source change rather than organic growth</p>
        </div>
        
        <div class="mb-4 p-3 bg-gray-50 rounded-lg">
            <div class="flex justify-between">
                <span class="font-medium">Schema validation failure for required building attributes</span>
                <span class="text-sm px-2 py-1 bg-red-100 rounded">HIGH</span>
            </div>
            <p class="text-sm text-gray-500 mt-1">99.7% missing names and 98.2% missing num_floors in buildings despite being marked as required fields indicates validation bypass</p>
        </div>
        
        <div class="mb-4 p-3 bg-gray-50 rounded-lg">
            <div class="flex justify-between">
                <span class="font-medium">Upstream data provider changes in Asia-Pacific region</span>
                <span class="text-sm px-2 py-1 bg-yellow-100 rounded">MEDIUM</span>
            </div>
            <p class="text-sm text-gray-500 mt-1">Concentrated additions in CN, VN, ID, NZ suggest regional data source updates or new provider integration</p>
        </div>
        
            </div>
            
            <!-- Recommended Actions -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Recommended Actions</h3>
                
        <div class="flex items-start gap-3 mb-3">
            <span class="px-2 py-1 bg-red-100 text-red-800 rounded text-xs font-semibold">IMMEDIATE</span>
            <div>
                <p class="font-medium">Investigate and potentially rollback divisions data processing pipeline</p>
                <p class="text-sm text-gray-500">974 critical anomalies with systematic doubling pattern indicates severe processing error affecting global city data</p>
            </div>
        </div>
        
        <div class="flex items-start gap-3 mb-3">
            <span class="px-2 py-1 bg-red-100 text-red-800 rounded text-xs font-semibold">IMMEDIATE</span>
            <div>
                <p class="font-medium">Audit building schema validation and data ingestion process</p>
                <p class="text-sm text-gray-500">99%+ missing required fields combined with net feature loss suggests broken validation and potential data corruption</p>
            </div>
        </div>
        
        <div class="flex items-start gap-3 mb-3">
            <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs font-semibold">SHORT_TERM</span>
            <div>
                <p class="font-medium">Verify data source changes in Asia-Pacific region</p>
                <p class="text-sm text-gray-500">Concentrated additions in CN, VN, ID may indicate legitimate expansion but requires validation given other anomalies</p>
            </div>
        </div>
        
        <div class="flex items-start gap-3 mb-3">
            <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-semibold">PREVENTIVE</span>
            <div>
                <p class="font-medium">Implement pre-release validation for systematic count changes >50%</p>
                <p class="text-sm text-gray-500">Would have caught the global city doubling pattern before release</p>
            </div>
        </div>
        
            </div>
        </div>
        
        <!-- Geographic Insights -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Geographic Insights</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    
        <div class="mb-4 p-3 bg-blue-50 rounded-lg">
            <p class="font-medium">Asia-Pacific dominance in data additions</p>
            <p class="text-sm text-gray-600 mt-1">Major data source updates or new provider integration in Asian markets, with China leading at 7,188 new divisions</p>
            <div class="flex gap-2 mt-2"><span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs mr-1">CN</span><span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs mr-1">VN</span><span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs mr-1">ID</span><span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs mr-1">JP</span></div>
        </div>
        
        <div class="mb-4 p-3 bg-blue-50 rounded-lg">
            <p class="font-medium">Global uniform impact on city classifications</p>
            <p class="text-sm text-gray-600 mt-1">Systematic processing change affecting city feature detection/classification worldwide, not region-specific</p>
            <div class="flex gap-2 mt-2"><span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs mr-1">US</span><span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs mr-1">CA</span><span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs mr-1">CN</span><span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs mr-1">IR</span><span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs mr-1">JP</span></div>
        </div>
        
        <div class="mb-4 p-3 bg-blue-50 rounded-lg">
            <p class="font-medium">Latin American expansion pattern</p>
            <p class="text-sm text-gray-600 mt-1">Significant data expansion in South America with Brazil and Argentina showing major additions (3,530 and 2,871 respectively)</p>
            <div class="flex gap-2 mt-2"><span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs mr-1">BR</span><span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs mr-1">AR</span><span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs mr-1">VE</span></div>
        </div>
        
                </div>
                <div style="height: 300px;">
                    <canvas id="countryChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Charts Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Anomalies by Theme</h3>
                <canvas id="themeChart"></canvas>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Anomalies by Type</h3>
                <canvas id="typeChart"></canvas>
            </div>
        </div>
        
        <!-- Comparison Table -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Rule-Based vs AI Agent Comparison</h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b-2 border-gray-200">
                            <th class="text-left py-3 px-4">Aspect</th>
                            <th class="text-left py-3 px-4 text-blue-600">Rule-Based</th>
                            <th class="text-left py-3 px-4 text-green-600">AI Agent</th>
                            <th class="text-center py-3 px-4">Winner</th>
                        </tr>
                    </thead>
                    <tbody>
                        
                        <tr class="border-b border-gray-100">
                            <td class="py-3 px-4 font-medium">Output Volume</td>
                            <td class="py-3 px-4 text-sm">1004 individual alerts</td>
                            <td class="py-3 px-4 text-sm">5 grouped patterns + interpretation</td>
                            <td class="py-3 px-4 text-center">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                                    AI Agent
                                </span>
                            </td>
                        </tr>
                        
                        <tr class="border-b border-gray-100">
                            <td class="py-3 px-4 font-medium">Root Cause Analysis</td>
                            <td class="py-3 px-4 text-sm">None - only flags threshold violations</td>
                            <td class="py-3 px-4 text-sm">Identifies systematic issues and root causes</td>
                            <td class="py-3 px-4 text-center">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                                    AI Agent
                                </span>
                            </td>
                        </tr>
                        
                        <tr class="border-b border-gray-100">
                            <td class="py-3 px-4 font-medium">Geographic Insights</td>
                            <td class="py-3 px-4 text-sm">Lists affected countries</td>
                            <td class="py-3 px-4 text-sm">Identifies geographic patterns and concentrations</td>
                            <td class="py-3 px-4 text-center">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                                    AI Agent
                                </span>
                            </td>
                        </tr>
                        
                        <tr class="border-b border-gray-100">
                            <td class="py-3 px-4 font-medium">Confidence Scores</td>
                            <td class="py-3 px-4 text-sm">Binary (anomaly or not)</td>
                            <td class="py-3 px-4 text-sm">Per-pattern confidence scores</td>
                            <td class="py-3 px-4 text-center">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                                    AI Agent
                                </span>
                            </td>
                        </tr>
                        
                        <tr class="border-b border-gray-100">
                            <td class="py-3 px-4 font-medium">Execution Speed</td>
                            <td class="py-3 px-4 text-sm">~2-5 seconds</td>
                            <td class="py-3 px-4 text-sm">~10-15 seconds (includes API call)</td>
                            <td class="py-3 px-4 text-center">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800">
                                    Rule-Based
                                </span>
                            </td>
                        </tr>
                        
                        <tr class="border-b border-gray-100">
                            <td class="py-3 px-4 font-medium">Cost</td>
                            <td class="py-3 px-4 text-sm">Free</td>
                            <td class="py-3 px-4 text-sm">~$0.02 per analysis</td>
                            <td class="py-3 px-4 text-center">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800">
                                    Rule-Based
                                </span>
                            </td>
                        </tr>
                        
                        <tr class="border-b border-gray-100">
                            <td class="py-3 px-4 font-medium">Determinism</td>
                            <td class="py-3 px-4 text-sm">100% reproducible</td>
                            <td class="py-3 px-4 text-sm">May vary slightly between runs</td>
                            <td class="py-3 px-4 text-center">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800">
                                    Rule-Based
                                </span>
                            </td>
                        </tr>
                        
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Data Quality Assessment -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Data Quality Assessment</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-2xl font-bold">CRITICAL</div>
                    <div class="text-gray-600">Overall Rating</div>
                </div>
                <div class="p-4">
                    <h4 class="font-semibold mb-2">Key Concerns</h4>
                    <ul class="text-sm text-gray-600"><li class="mb-1">• Systematic feature duplication</li><li class="mb-1">• Required field validation failure</li><li class="mb-1">• Potential data corruption in divisions</li></ul>
                </div>
                <div class="p-4">
                    <h4 class="font-semibold mb-2">Most Affected Themes</h4>
                    <div class="flex flex-wrap gap-2"><span class="px-2 py-1 bg-red-100 text-red-800 rounded text-sm mr-1">divisions</span><span class="px-2 py-1 bg-red-100 text-red-800 rounded text-sm mr-1">buildings</span><span class="px-2 py-1 bg-red-100 text-red-800 rounded text-sm mr-1">transportation</span></div>
                </div>
            </div>
        </div>
        
    </div>
    
    <script>
        // Toggle function for showing/hiding anomaly details
        function toggleDetails(elementId) {
            const el = document.getElementById(elementId);
            if (el) {
                el.classList.toggle('hidden');
                const btn = el.previousElementSibling;
                if (btn && btn.tagName === 'BUTTON') {
                    btn.textContent = el.classList.contains('hidden') 
                        ? '▶ Show underlying anomalies' 
                        : '▼ Hide underlying anomalies';
                }
            }
        }
        
        // Theme chart
        const themeData = {"base": {"critical": 3, "warning": 8, "info": 0}, "buildings": {"critical": 3, "warning": 3, "info": 0}, "divisions": {"critical": 952, "warning": 1, "info": 0}, "places": {"critical": 4, "warning": 2, "info": 0}, "transportation": {"critical": 27, "warning": 0, "info": 0}, "addresses": {"critical": 0, "warning": 1, "info": 0}};
        const themeLabels = Object.keys(themeData);
        const themeCritical = themeLabels.map(t => themeData[t].critical || 0);
        const themeWarning = themeLabels.map(t => themeData[t].warning || 0);
        
        new Chart(document.getElementById('themeChart'), {
            type: 'bar',
            data: {
                labels: themeLabels,
                datasets: [
                    { label: 'Critical', data: themeCritical, backgroundColor: '#dc2626' },
                    { label: 'Warning', data: themeWarning, backgroundColor: '#f59e0b' }
                ]
            },
            options: {
                responsive: true,
                scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }
            }
        });
        
        // Type chart
        const typeData = {"net_feature_gain": 7, "low_attribute_coverage": 11, "geometry_length_change": 3, "net_feature_loss": 1, "feature_count_spike": 974, "feature_count_drop": 4, "high_removal_rate": 1, "data_regeneration": 1, "high_addition_rate": 1, "churn_spike": 1};
        new Chart(document.getElementById('typeChart'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(typeData),
                datasets: [{
                    data: Object.values(typeData),
                    backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16']
                }]
            },
            options: { responsive: true }
        });
        
        // Country chart
        const countryLabels = ["US", "CA", "CN", "IR", "JP", "RU", "IN", "MX", "RO", "VE", "TR", "PT", "AR", "AU", "BY", "CH", "DE", "FR", "GB", "IQ"];
        const countryCritical = [13, 11, 11, 11, 11, 11, 10, 10, 10, 10, 10, 9, 8, 9, 9, 9, 9, 9, 9, 9];
        const countryWarning = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0];
        
        new Chart(document.getElementById('countryChart'), {
            type: 'bar',
            data: {
                labels: countryLabels,
                datasets: [
                    { label: 'Critical', data: countryCritical, backgroundColor: '#dc2626' },
                    { label: 'Warning', data: countryWarning, backgroundColor: '#f59e0b' }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                scales: { x: { stacked: true }, y: { stacked: true } }
            }
        });
    </script>
    
    <!-- Chat Panel -->
    <div id="chatPanel" class="fixed bottom-4 right-4 z-50">
        <!-- Chat Toggle Button -->
        <button id="chatToggle" onclick="toggleChat()" 
                class="bg-blue-600 hover:bg-blue-700 text-white rounded-full p-4 shadow-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
            </svg>
        </button>
        
        <!-- Chat Window -->
        <div id="chatWindow" class="hidden absolute bottom-16 right-0 w-96 bg-white rounded-lg shadow-2xl border border-gray-200">
            <div class="bg-blue-600 text-white p-3 rounded-t-lg flex justify-between items-center">
                <span class="font-semibold">Ask about anomalies</span>
                <button onclick="toggleChat()" class="text-white hover:text-gray-200">&times;</button>
            </div>
            
            <div id="chatMessages" class="h-80 overflow-y-auto p-4 space-y-3">
                <div class="bg-gray-100 rounded-lg p-3 text-sm">
                    <p class="font-medium text-gray-700">AI Assistant</p>
                    <p class="text-gray-600">Ask me questions about the anomalies, like:</p>
                    <ul class="text-gray-500 text-xs mt-1 list-disc list-inside">
                        <li>Which countries are most affected?</li>
                        <li>What should I prioritize fixing?</li>
                        <li>Explain the duplication pattern</li>
                        <li>What files should I check?</li>
                    </ul>
                </div>
            </div>
            
            <div class="border-t p-3">
                <div class="flex gap-2">
                    <input type="text" id="chatInput" 
                           placeholder="Ask a question..." 
                           class="flex-1 border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                           onkeypress="if(event.key==='Enter')sendMessage()">
                    <button onclick="sendMessage()" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                        Send
                    </button>
                </div>
                <p id="chatStatus" class="text-xs text-gray-400 mt-1 hidden">Thinking...</p>
            </div>
        </div>
    </div>
    
    <script>
        // Chat functionality
        const anomalyContext = {"summary": "Release 2025-09-24.0 shows severe data quality issues with 1004 anomalies (989 critical), dominated by systematic feature count spikes in divisions data affecting 192 countries. The divisions theme accounts for 96% of critical anomalies, with widespread ~100% increases in city counts globally, indicating a likely data processing error or source change.", "patterns": [{"name": "Global City Count Doubling", "description": "Systematic doubling of city features across all major countries with ~100% increases", "affected_themes": ["divisions"], "affected_countries": ["CN", "BR", "CA", "IN", "JP", "IR", "MX", "EG", "PH"], "anomaly_count": 974, "severity": "CRITICAL", "confidence": 0.95, "evidence": "974 feature_count_spike anomalies in divisions theme, with consistent ~100% increases: CN (99.94%), CA (98.91%), BR (100.56%), IN (102.32%), JP (100.0%)"}, {"name": "Infrastructure Data Surge", "description": "Massive net gain of infrastructure features with high addition-to-removal ratio", "affected_themes": ["base"], "affected_countries": [], "anomaly_count": 1, "severity": "CRITICAL", "confidence": 0.9, "evidence": "Net gain of 1,367,815 infrastructure features (1,501,897 added vs 134,082 removed), representing 11:1 addition ratio"}, {"name": "Building Data Degradation", "description": "Net loss of buildings combined with poor attribute coverage for required fields", "affected_themes": ["buildings"], "affected_countries": [], "anomaly_count": 6, "severity": "CRITICAL", "confidence": 0.85, "evidence": "Net loss of 4,318,594 buildings, 99.7% missing names, 98.2% missing num_floors despite being required fields"}, {"name": "Transportation Network Changes", "description": "Significant modifications to transportation infrastructure across multiple countries", "affected_themes": ["transportation"], "affected_countries": [], "anomaly_count": 27, "severity": "CRITICAL", "confidence": 0.75, "evidence": "27 critical transportation anomalies with no warnings, suggesting systematic changes rather than gradual updates"}, {"name": "Geographic Data Expansion", "description": "Major additions of division features concentrated in Asia-Pacific and Latin America", "affected_themes": ["divisions"], "affected_countries": ["CN", "BR", "AR", "VN", "ID", "NZ"], "anomaly_count": 2, "severity": "INFO", "confidence": 0.8, "evidence": "Top additions: CN (7,188 divisions), BR (3,530), AR (2,871), VN (2,534), NZ (3,179 division_areas)"}], "root_causes": [{"hypothesis": "Data source migration or processing pipeline change for divisions", "likelihood": "HIGH", "evidence": "Systematic ~100% increases across all countries in city counts suggests duplicate processing or source change rather than organic growth"}, {"hypothesis": "Schema validation failure for required building attributes", "likelihood": "HIGH", "evidence": "99.7% missing names and 98.2% missing num_floors in buildings despite being marked as required fields indicates validation bypass"}, {"hypothesis": "Upstream data provider changes in Asia-Pacific region", "likelihood": "MEDIUM", "evidence": "Concentrated additions in CN, VN, ID, NZ suggest regional data source updates or new provider integration"}], "total_anomalies": 1004, "critical_count": 0, "by_theme": {"base": {"critical": 3, "warning": 8, "info": 0}, "buildings": {"critical": 3, "warning": 3, "info": 0}, "divisions": {"critical": 952, "warning": 1, "info": 0}, "places": {"critical": 4, "warning": 2, "info": 0}, "transportation": {"critical": 27, "warning": 0, "info": 0}, "addresses": {"critical": 0, "warning": 1, "info": 0}}, "by_type": {"net_feature_gain": 7, "low_attribute_coverage": 11, "geometry_length_change": 3, "net_feature_loss": 1, "feature_count_spike": 974, "feature_count_drop": 4, "high_removal_rate": 1, "data_regeneration": 1, "high_addition_rate": 1, "churn_spike": 1}, "top_countries": {"US": {"critical": 13, "warning": 0, "info": 0, "total": 13}, "CA": {"critical": 11, "warning": 0, "info": 0, "total": 11}, "CN": {"critical": 11, "warning": 0, "info": 0, "total": 11}, "IR": {"critical": 11, "warning": 0, "info": 0, "total": 11}, "JP": {"critical": 11, "warning": 0, "info": 0, "total": 11}, "RU": {"critical": 11, "warning": 0, "info": 0, "total": 11}, "IN": {"critical": 10, "warning": 0, "info": 0, "total": 10}, "MX": {"critical": 10, "warning": 0, "info": 0, "total": 10}, "RO": {"critical": 10, "warning": 0, "info": 0, "total": 10}, "VE": {"critical": 10, "warning": 0, "info": 0, "total": 10}, "TR": {"critical": 10, "warning": 0, "info": 0, "total": 10}, "PT": {"critical": 9, "warning": 0, "info": 0, "total": 9}, "AR": {"critical": 8, "warning": 1, "info": 0, "total": 9}, "AU": {"critical": 9, "warning": 0, "info": 0, "total": 9}, "BY": {"critical": 9, "warning": 0, "info": 0, "total": 9}, "CH": {"critical": 9, "warning": 0, "info": 0, "total": 9}, "DE": {"critical": 9, "warning": 0, "info": 0, "total": 9}, "FR": {"critical": 9, "warning": 0, "info": 0, "total": 9}, "GB": {"critical": 9, "warning": 0, "info": 0, "total": 9}, "IQ": {"critical": 9, "warning": 0, "info": 0, "total": 9}}, "recommended_actions": [{"priority": "IMMEDIATE", "action": "Investigate and potentially rollback divisions data processing pipeline", "rationale": "974 critical anomalies with systematic doubling pattern indicates severe processing error affecting global city data"}, {"priority": "IMMEDIATE", "action": "Audit building schema validation and data ingestion process", "rationale": "99%+ missing required fields combined with net feature loss suggests broken validation and potential data corruption"}, {"priority": "SHORT_TERM", "action": "Verify data source changes in Asia-Pacific region", "rationale": "Concentrated additions in CN, VN, ID may indicate legitimate expansion but requires validation given other anomalies"}, {"priority": "PREVENTIVE", "action": "Implement pre-release validation for systematic count changes >50%", "rationale": "Would have caught the global city doubling pattern before release"}]};
        
        let chatHistory = [];
        
        function toggleChat() {
            const chatWindow = document.getElementById('chatWindow');
            chatWindow.classList.toggle('hidden');
        }
        
        function addMessage(content, isUser) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser 
                ? 'bg-blue-100 rounded-lg p-3 text-sm ml-8' 
                : 'bg-gray-100 rounded-lg p-3 text-sm mr-8';
            messageDiv.innerHTML = `
                <p class="font-medium ${isUser ? 'text-blue-700' : 'text-gray-700'}">${isUser ? 'You' : 'AI Assistant'}</p>
                <p class="text-gray-600 whitespace-pre-wrap">${content}</p>
            `;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const status = document.getElementById('chatStatus');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addMessage(message, true);
            input.value = '';
            status.classList.remove('hidden');
            
            // Build prompt with context
            const systemPrompt = `You are an AI assistant helping analyze Overture Maps release anomalies. 
            
Here is the context about the current anomaly analysis:

Executive Summary: ${anomalyContext.summary}

Total Anomalies: ${anomalyContext.total_anomalies}
Critical: ${anomalyContext.critical_count}

Patterns Identified:
${JSON.stringify(anomalyContext.patterns, null, 2)}

Root Causes:
${JSON.stringify(anomalyContext.root_causes, null, 2)}

By Theme: ${JSON.stringify(anomalyContext.by_theme)}
By Type: ${JSON.stringify(anomalyContext.by_type)}
Top Countries: ${JSON.stringify(anomalyContext.top_countries)}

Recommended Actions:
${JSON.stringify(anomalyContext.recommended_actions, null, 2)}

Answer the user's question concisely based on this context. If asked about files to check, suggest looking at the metrics files for the relevant theme/type.`;

            chatHistory.push({ role: 'user', content: message });
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': localStorage.getItem('anthropic_api_key') || '',
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1024,
                        system: systemPrompt,
                        messages: chatHistory
                    })
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        const apiKey = prompt('Enter your Anthropic API key for chat:');
                        if (apiKey) {
                            localStorage.setItem('anthropic_api_key', apiKey);
                            addMessage('API key saved. Please try your question again.', false);
                        } else {
                            addMessage('Chat requires an API key. Enter it when prompted.', false);
                        }
                    } else {
                        throw new Error(`API error: ${response.status}`);
                    }
                    status.classList.add('hidden');
                    return;
                }
                
                const data = await response.json();
                const assistantMessage = data.content[0].text;
                
                chatHistory.push({ role: 'assistant', content: assistantMessage });
                addMessage(assistantMessage, false);
                
            } catch (error) {
                addMessage(`Error: ${error.message}. Make sure you have a valid API key.`, false);
            }
            
            status.classList.add('hidden');
        }
    </script>
    
    <footer class="bg-gray-800 text-white py-6">
        <div class="container mx-auto px-4 text-center text-sm opacity-75">
            Overture Maps Anomaly Detection System | Generated: 2025-12-03T21:50:13.190883
        </div>
    </footer>
</body>
</html>
